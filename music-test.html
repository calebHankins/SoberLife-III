<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸµ Adaptive Music Test Lab</title>
    <!-- Favicon -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸµ</text></svg>"
        type="image/svg+xml">
    <style>
        body {
            font-family: 'Comic Sans MS', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .control-section h3 {
            margin-top: 0;
            color: #ffd700;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffd700;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .value-display {
            min-width: 60px;
            text-align: right;
            font-weight: bold;
            color: #ffd700;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .stress-buttons button {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }

        .event-buttons button {
            background: linear-gradient(45deg, #ffecd2, #fcb69f);
            color: #333;
        }

        .config-section {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .config-output {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-display {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .current-mood {
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .stress-level {
            font-size: 18px;
            margin-top: 10px;
        }

        .config-controls {
            margin-bottom: 15px;
        }

        .preset-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .preset-controls select,
        .preset-controls input {
            flex: 1;
            min-width: 150px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .instructions-section h4 {
            color: #ffd700;
            margin-top: 15px;
            margin-bottom: 8px;
        }

        .instructions-section ul {
            margin: 0;
            padding-left: 20px;
        }

        .instructions-section li {
            margin-bottom: 5px;
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 15px;
            }

            .instructions-section>div {
                grid-template-columns: 1fr;
            }

            .preset-controls {
                flex-direction: column;
            }

            .preset-controls select,
            .preset-controls input {
                min-width: auto;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸµ Adaptive Music Test Lab ğŸµ</h1>

        <div class="status-display">
            <div class="current-mood" id="currentMood">Moderate</div>
            <div class="stress-level">Stress Level: <span id="stressLevel">50</span>%</div>
        </div>

        <div class="button-group stress-buttons">
            <button onclick="setStressLevel(10)">ğŸ˜Œ Calm (10%)</button>
            <button onclick="setStressLevel(30)">ğŸ™‚ Low (30%)</button>
            <button onclick="setStressLevel(50)">ğŸ˜ Moderate (50%)</button>
            <button onclick="setStressLevel(70)">ğŸ˜° High (70%)</button>
            <button onclick="setStressLevel(90)">ğŸ˜µ Extreme (90%)</button>
        </div>

        <div class="button-group event-buttons">
            <button onclick="triggerEvent('handWin')">ğŸ‰ Hand Win</button>
            <button onclick="triggerEvent('handLose')">ğŸ˜” Hand Lose</button>
            <button onclick="triggerEvent('bust')">ğŸ’¥ Bust</button>
            <button onclick="triggerEvent('taskComplete')">ğŸ† Task Complete</button>
        </div>

        <div class="button-group">
            <button onclick="toggleMusic()" id="musicToggle">ğŸµ Start Music</button>
            <button onclick="exportConfig()">ğŸ“‹ Export Config</button>
            <button onclick="importConfig()">ğŸ“ Import Config</button>
            <button onclick="resetToDefaults()">ğŸ”„ Reset Defaults</button>
            <button onclick="savePreset()">ğŸ’¾ Save Preset</button>
            <button onclick="loadPreset()">ğŸ“‚ Load Preset</button>
        </div>

        <div class="controls-grid">
            <!-- Calm Settings -->
            <div class="control-section">
                <h3>ğŸ˜Œ Calm Music (0-30% stress)</h3>

                <div class="control-group">
                    <label>Tempo Multiplier</label>
                    <div class="slider-container">
                        <input type="range" id="calmTempo" min="0.1" max="2.0" step="0.1" value="0.5">
                        <span class="value-display" id="calmTempoValue">0.5x</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Volume Multiplier</label>
                    <div class="slider-container">
                        <input type="range" id="calmVolume" min="0.1" max="2.0" step="0.1" value="0.6">
                        <span class="value-display" id="calmVolumeValue">0.6x</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Filter Cutoff (Hz)</label>
                    <div class="slider-container">
                        <input type="range" id="calmFilter" min="500" max="5000" step="100" value="1200">
                        <span class="value-display" id="calmFilterValue">1200Hz</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Melody Frequency</label>
                    <div class="slider-container">
                        <input type="range" id="calmMelody" min="0.0" max="1.0" step="0.1" value="0.1">
                        <span class="value-display" id="calmMelodyValue">0.1</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Rhythm Intensity</label>
                    <div class="slider-container">
                        <input type="range" id="calmRhythm" min="0.1" max="3.0" step="0.1" value="0.3">
                        <span class="value-display" id="calmRhythmValue">0.3</span>
                    </div>
                </div>
            </div>

            <!-- Moderate Settings -->
            <div class="control-section">
                <h3>ğŸ˜ Moderate Music (30-70% stress)</h3>

                <div class="control-group">
                    <label>Tempo Multiplier</label>
                    <div class="slider-container">
                        <input type="range" id="moderateTempo" min="0.1" max="2.0" step="0.1" value="1.0">
                        <span class="value-display" id="moderateTempoValue">1.0x</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Volume Multiplier</label>
                    <div class="slider-container">
                        <input type="range" id="moderateVolume" min="0.1" max="2.0" step="0.1" value="1.0">
                        <span class="value-display" id="moderateVolumeValue">1.0x</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Filter Cutoff (Hz)</label>
                    <div class="slider-container">
                        <input type="range" id="moderateFilter" min="500" max="5000" step="100" value="2500">
                        <span class="value-display" id="moderateFilterValue">2500Hz</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Melody Frequency</label>
                    <div class="slider-container">
                        <input type="range" id="moderateMelody" min="0.0" max="1.0" step="0.1" value="0.5">
                        <span class="value-display" id="moderateMelodyValue">0.5</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Rhythm Intensity</label>
                    <div class="slider-container">
                        <input type="range" id="moderateRhythm" min="0.1" max="3.0" step="0.1" value="1.0">
                        <span class="value-display" id="moderateRhythmValue">1.0</span>
                    </div>
                </div>
            </div>

            <!-- Tense Settings -->
            <div class="control-section">
                <h3>ğŸ˜° Tense Music (70-100% stress)</h3>

                <div class="control-group">
                    <label>Tempo Multiplier</label>
                    <div class="slider-container">
                        <input type="range" id="tenseTempo" min="0.1" max="3.0" step="0.1" value="2.2">
                        <span class="value-display" id="tenseTempoValue">2.2x</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Volume Multiplier</label>
                    <div class="slider-container">
                        <input type="range" id="tenseVolume" min="0.1" max="2.0" step="0.1" value="1.4">
                        <span class="value-display" id="tenseVolumeValue">1.4x</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Filter Cutoff (Hz)</label>
                    <div class="slider-container">
                        <input type="range" id="tenseFilter" min="500" max="8000" step="100" value="5000">
                        <span class="value-display" id="tenseFilterValue">5000Hz</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Melody Frequency</label>
                    <div class="slider-container">
                        <input type="range" id="tenseMelody" min="0.0" max="1.0" step="0.1" value="0.9">
                        <span class="value-display" id="tenseMelodyValue">0.9</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Rhythm Intensity</label>
                    <div class="slider-container">
                        <input type="range" id="tenseRhythm" min="0.1" max="3.0" step="0.1" value="2.0">
                        <span class="value-display" id="tenseRhythmValue">2.0</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="config-section">
            <h3>ğŸ“‹ Configuration Export/Import</h3>
            <div class="config-controls">
                <textarea id="configInput" placeholder="Paste configuration JSON here to import..." rows="4"
                    style="width: 100%; margin-bottom: 10px; padding: 10px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.2); color: white; font-family: 'Courier New', monospace;"></textarea>
                <div class="preset-controls">
                    <select id="presetSelect"
                        style="padding: 8px; margin-right: 10px; border-radius: 5px; background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.3);">
                        <option value="">Select a preset...</option>
                    </select>
                    <input type="text" id="presetName" placeholder="Preset name..."
                        style="padding: 8px; margin-right: 10px; border-radius: 5px; background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.3);">
                </div>
            </div>
            <div class="config-output" id="configOutput">
                Click "Export Config" to generate configuration code for the main game.
            </div>
        </div>

        <div class="instructions-section"
            style="background: rgba(0, 0, 0, 0.2); border-radius: 15px; padding: 20px; margin-top: 20px;">
            <h3>ğŸ¯ How to Use This Music Test Lab</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h4>ğŸµ Testing Music</h4>
                    <ul style="text-align: left; padding-left: 20px;">
                        <li>Click "Start Music" to begin audio playback</li>
                        <li>Use stress level buttons to test different moods</li>
                        <li>Trigger game events to hear audio responses</li>
                        <li>Adjust sliders in real-time to hear changes</li>
                    </ul>

                    <h4>âš™ï¸ Configuration</h4>
                    <ul style="text-align: left; padding-left: 20px;">
                        <li>Export: Copy generated code to main game</li>
                        <li>Import: Paste JSON config to load settings</li>
                        <li>Presets: Save/load your favorite configurations</li>
                        <li>Reset: Return to default values</li>
                    </ul>
                </div>
                <div>
                    <h4>ğŸ›ï¸ Controls Explained</h4>
                    <ul style="text-align: left; padding-left: 20px;">
                        <li><strong>Tempo:</strong> Speed of music (0.1x = very slow, 3x = very fast)</li>
                        <li><strong>Volume:</strong> Loudness multiplier for each mood</li>
                        <li><strong>Filter:</strong> Brightness (low = warm, high = bright)</li>
                        <li><strong>Melody:</strong> How often melody notes play (0 = none, 1 = constant)</li>
                        <li><strong>Rhythm:</strong> Intensity of rhythmic variations</li>
                    </ul>

                    <h4>ğŸ’¡ Tips</h4>
                    <ul style="text-align: left; padding-left: 20px;">
                        <li>Start with music playing to hear changes immediately</li>
                        <li>Test all stress levels to ensure smooth transitions</li>
                        <li>Save presets for different scenarios (calm office, tense DMV, etc.)</li>
                        <li>Export final config and paste into assets/js/audio-system.js</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the audio system
        import { AudioManager, adaptiveMusicConfig } from './assets/js/audio-system.js';

        // Global variables
        let audioManager = null;
        let currentStressLevel = 50;
        let musicPlaying = false;

        // Initialize audio system
        async function initAudio() {
            try {
                audioManager = new AudioManager();
                await audioManager.init();

                // Expose globally for debugging
                window.audioManager = audioManager;

                console.log('Music Test: Audio system initialized');
            } catch (error) {
                console.error('Music Test: Failed to initialize audio:', error);
            }
        }

        // Set stress level and update music
        window.setStressLevel = function (level) {
            currentStressLevel = level;
            document.getElementById('stressLevel').textContent = level;

            // Update mood display
            let mood = 'Moderate';
            if (level < 30) mood = 'Calm';
            else if (level > 70) mood = 'Tense';
            document.getElementById('currentMood').textContent = mood;

            // Update music if playing
            if (audioManager && audioManager.musicPlayer && musicPlaying) {
                // Apply current settings to the music player
                updateMusicSettings();

                // Trigger stress level change
                if (audioManager.musicPlayer.updateStressLevel) {
                    audioManager.musicPlayer.updateStressLevel(level);
                }
            }

            console.log(`Music Test: Set stress level to ${level}%`);
        };

        // Trigger game events
        window.triggerEvent = function (eventType) {
            if (audioManager && audioManager.musicPlayer && musicPlaying) {
                // Dispatch event
                document.dispatchEvent(new CustomEvent('gameEvent', {
                    detail: { type: eventType, data: {} }
                }));
                console.log(`Music Test: Triggered ${eventType} event`);
            } else {
                console.log('Music Test: Start music first to test events');
            }
        };

        // Toggle music playback
        window.toggleMusic = async function () {
            if (!audioManager) {
                await initAudio();
            }

            const button = document.getElementById('musicToggle');

            if (!musicPlaying) {
                // Resume audio context if needed
                if (audioManager.audioContext && audioManager.audioContext.state === 'suspended') {
                    await audioManager.audioContext.resume();
                }

                // Set user interaction flag
                audioManager.userInteracted = true;

                // Start music
                audioManager.startMusic();
                updateMusicSettings();
                setStressLevel(currentStressLevel); // Apply current stress level

                button.textContent = 'ğŸ”‡ Stop Music';
                musicPlaying = true;
                console.log('Music Test: Started music');
            } else {
                // Stop music
                audioManager.stopMusic();
                button.textContent = 'ğŸµ Start Music';
                musicPlaying = false;
                console.log('Music Test: Stopped music');
            }
        };

        // Update music settings based on current slider values
        function updateMusicSettings() {
            if (!audioManager || !audioManager.musicPlayer) return;

            // Get current values from sliders
            const config = {
                stressLevels: {
                    calm: {
                        tempo: parseFloat(document.getElementById('calmTempo').value),
                        volume: parseFloat(document.getElementById('calmVolume').value),
                        filterCutoff: parseInt(document.getElementById('calmFilter').value),
                        melodyFrequency: parseFloat(document.getElementById('calmMelody').value),
                        rhythmIntensity: parseFloat(document.getElementById('calmRhythm').value)
                    },
                    moderate: {
                        tempo: parseFloat(document.getElementById('moderateTempo').value),
                        volume: parseFloat(document.getElementById('moderateVolume').value),
                        filterCutoff: parseInt(document.getElementById('moderateFilter').value),
                        melodyFrequency: parseFloat(document.getElementById('moderateMelody').value),
                        rhythmIntensity: parseFloat(document.getElementById('moderateRhythm').value)
                    },
                    tense: {
                        tempo: parseFloat(document.getElementById('tenseTempo').value),
                        volume: parseFloat(document.getElementById('tenseVolume').value),
                        filterCutoff: parseInt(document.getElementById('tenseFilter').value),
                        melodyFrequency: parseFloat(document.getElementById('tenseMelody').value),
                        rhythmIntensity: parseFloat(document.getElementById('tenseRhythm').value)
                    }
                }
            };

            // Update the global config (this is a bit hacky but works for testing)
            if (window.adaptiveMusicConfig) {
                Object.assign(window.adaptiveMusicConfig.stressLevels, config.stressLevels);
            }

            console.log('Music Test: Updated music settings');
        }

        // Get current configuration as object
        function getCurrentConfig() {
            return {
                stressLevels: {
                    calm: {
                        range: [0, 30],
                        tempo: parseFloat(document.getElementById('calmTempo').value),
                        harmonicComplexity: 'simple',
                        filterCutoff: parseInt(document.getElementById('calmFilter').value),
                        reverbAmount: 0.5,
                        melodyFrequency: parseFloat(document.getElementById('calmMelody').value),
                        rhythmIntensity: parseFloat(document.getElementById('calmRhythm').value),
                        volume: parseFloat(document.getElementById('calmVolume').value),
                        chordProgression: [
                            [130.81, 164.81, 196], // C3 (C, E, G) - very low and peaceful
                            [146.83, 174.61, 220], // D3 (D, F, A) - gentle
                            [164.81, 196, 246.94], // E3 (E, G, B) - resolved
                            [146.83, 184.99, 220]  // D3 (D, F#, A) - warm major
                        ]
                    },
                    moderate: {
                        range: [30, 70],
                        tempo: parseFloat(document.getElementById('moderateTempo').value),
                        harmonicComplexity: 'moderate',
                        filterCutoff: parseInt(document.getElementById('moderateFilter').value),
                        reverbAmount: 0.25,
                        melodyFrequency: parseFloat(document.getElementById('moderateMelody').value),
                        rhythmIntensity: parseFloat(document.getElementById('moderateRhythm').value),
                        volume: parseFloat(document.getElementById('moderateVolume').value),
                        chordProgression: [
                            [220, 261.63, 329.63], // Am (A, C, E)
                            [196, 246.94, 293.66], // G (G, B, D)
                            [261.63, 329.63, 392],  // C (C, E, G)
                            [174.61, 220, 261.63]   // F (F, A, C)
                        ]
                    },
                    tense: {
                        range: [70, 100],
                        tempo: parseFloat(document.getElementById('tenseTempo').value),
                        harmonicComplexity: 'complex',
                        filterCutoff: parseInt(document.getElementById('tenseFilter').value),
                        reverbAmount: 0.05,
                        melodyFrequency: parseFloat(document.getElementById('tenseMelody').value),
                        rhythmIntensity: parseFloat(document.getElementById('tenseRhythm').value),
                        volume: parseFloat(document.getElementById('tenseVolume').value),
                        chordProgression: [
                            [277.18, 329.63, 415.30], // C# (C#, E, G#) - high and dissonant
                            [311.13, 369.99, 466.16], // D# (D#, F#, A#) - very tense
                            [329.63, 415.30, 493.88], // E (E, G#, B) - unstable high
                            [293.66, 369.99, 440]     // D (D, F#, A) - anxious high
                        ]
                    }
                }
            };
        }

        // Export configuration
        window.exportConfig = function () {
            const config = getCurrentConfig();

            const configText = `// Adaptive Music Configuration
// Copy this into your assets/js/audio-system.js file, replacing the existing adaptiveMusicConfig.stressLevels

const adaptiveMusicConfig = {
    stressLevels: ${JSON.stringify(config.stressLevels, null, 8)},
    // ... rest of your config
};`;

            document.getElementById('configOutput').textContent = configText;

            // Also copy to clipboard if available
            if (navigator.clipboard) {
                navigator.clipboard.writeText(configText).then(() => {
                    console.log('Music Test: Configuration copied to clipboard');
                    showNotification('Configuration copied to clipboard!');
                }).catch(err => {
                    console.log('Music Test: Could not copy to clipboard:', err);
                });
            }

            console.log('Music Test: Configuration exported');
        };

        // Import configuration
        window.importConfig = function () {
            const configInput = document.getElementById('configInput');
            const configText = configInput.value.trim();

            if (!configText) {
                showNotification('Please paste a configuration in the text area first.', 'error');
                return;
            }

            try {
                // Try to parse as JSON first
                let config;
                if (configText.startsWith('{')) {
                    config = JSON.parse(configText);
                } else {
                    // Try to extract JSON from JavaScript code
                    const jsonMatch = configText.match(/stressLevels:\s*({[\s\S]*?}),?\s*(?:\/\/|$)/);
                    if (jsonMatch) {
                        config = { stressLevels: JSON.parse(jsonMatch[1]) };
                    } else {
                        throw new Error('Could not find stressLevels configuration in the provided text');
                    }
                }

                if (config.stressLevels) {
                    applyConfigToUI(config.stressLevels);
                    showNotification('Configuration imported successfully!');
                    configInput.value = '';

                    // Update music if playing
                    if (musicPlaying) {
                        updateMusicSettings();
                        setStressLevel(currentStressLevel);
                    }
                } else {
                    throw new Error('Invalid configuration format - missing stressLevels');
                }
            } catch (error) {
                console.error('Music Test: Import error:', error);
                showNotification('Error importing configuration: ' + error.message, 'error');
            }
        };

        // Apply configuration to UI
        function applyConfigToUI(stressLevels) {
            if (stressLevels.calm) {
                document.getElementById('calmTempo').value = stressLevels.calm.tempo || 0.5;
                document.getElementById('calmVolume').value = stressLevels.calm.volume || 0.6;
                document.getElementById('calmFilter').value = stressLevels.calm.filterCutoff || 1200;
                document.getElementById('calmMelody').value = stressLevels.calm.melodyFrequency || 0.1;
                document.getElementById('calmRhythm').value = stressLevels.calm.rhythmIntensity || 0.3;
            }

            if (stressLevels.moderate) {
                document.getElementById('moderateTempo').value = stressLevels.moderate.tempo || 1.0;
                document.getElementById('moderateVolume').value = stressLevels.moderate.volume || 1.0;
                document.getElementById('moderateFilter').value = stressLevels.moderate.filterCutoff || 2500;
                document.getElementById('moderateMelody').value = stressLevels.moderate.melodyFrequency || 0.5;
                document.getElementById('moderateRhythm').value = stressLevels.moderate.rhythmIntensity || 1.0;
            }

            if (stressLevels.tense) {
                document.getElementById('tenseTempo').value = stressLevels.tense.tempo || 2.2;
                document.getElementById('tenseVolume').value = stressLevels.tense.volume || 1.4;
                document.getElementById('tenseFilter').value = stressLevels.tense.filterCutoff || 5000;
                document.getElementById('tenseMelody').value = stressLevels.tense.melodyFrequency || 0.9;
                document.getElementById('tenseRhythm').value = stressLevels.tense.rhythmIntensity || 2.0;
            }

            updateSliderDisplays();
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 10px;
                color: white;
                font-weight: bold;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                background: ${type === 'error' ? '#e74c3c' : '#27ae60'};
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Preset management
        let savedPresets = JSON.parse(localStorage.getItem('musicTestPresets') || '{}');

        // Save preset
        window.savePreset = function () {
            const presetName = document.getElementById('presetName').value.trim();
            if (!presetName) {
                showNotification('Please enter a preset name.', 'error');
                return;
            }

            const config = getCurrentConfig();
            savedPresets[presetName] = config;
            localStorage.setItem('musicTestPresets', JSON.stringify(savedPresets));

            updatePresetSelect();
            document.getElementById('presetName').value = '';
            showNotification(`Preset "${presetName}" saved!`);
        };

        // Load preset
        window.loadPreset = function () {
            const presetSelect = document.getElementById('presetSelect');
            const presetName = presetSelect.value;

            if (!presetName || !savedPresets[presetName]) {
                showNotification('Please select a preset to load.', 'error');
                return;
            }

            applyConfigToUI(savedPresets[presetName].stressLevels);
            showNotification(`Preset "${presetName}" loaded!`);

            // Update music if playing
            if (musicPlaying) {
                updateMusicSettings();
                setStressLevel(currentStressLevel);
            }
        };

        // Update preset select dropdown
        function updatePresetSelect() {
            const presetSelect = document.getElementById('presetSelect');
            presetSelect.innerHTML = '<option value="">Select a preset...</option>';

            Object.keys(savedPresets).forEach(presetName => {
                const option = document.createElement('option');
                option.value = presetName;
                option.textContent = presetName;
                presetSelect.appendChild(option);
            });
        }

        // Reset to default values
        window.resetToDefaults = function () {
            // Calm defaults
            document.getElementById('calmTempo').value = 0.5;
            document.getElementById('calmVolume').value = 0.6;
            document.getElementById('calmFilter').value = 1200;
            document.getElementById('calmMelody').value = 0.1;
            document.getElementById('calmRhythm').value = 0.3;

            // Moderate defaults
            document.getElementById('moderateTempo').value = 1.0;
            document.getElementById('moderateVolume').value = 1.0;
            document.getElementById('moderateFilter').value = 2500;
            document.getElementById('moderateMelody').value = 0.5;
            document.getElementById('moderateRhythm').value = 1.0;

            // Tense defaults
            document.getElementById('tenseTempo').value = 2.2;
            document.getElementById('tenseVolume').value = 1.4;
            document.getElementById('tenseFilter').value = 5000;
            document.getElementById('tenseMelody').value = 0.9;
            document.getElementById('tenseRhythm').value = 2.0;

            updateSliderDisplays();
            if (musicPlaying) {
                updateMusicSettings();
                setStressLevel(currentStressLevel);
            }
            console.log('Music Test: Reset to defaults');
        };

        // Update slider value displays
        function updateSliderDisplays() {
            const sliders = document.querySelectorAll('input[type="range"]');
            sliders.forEach(slider => {
                const valueDisplay = document.getElementById(slider.id + 'Value');
                if (valueDisplay) {
                    let value = slider.value;
                    if (slider.id.includes('Tempo') || slider.id.includes('Volume') || slider.id.includes('Melody') || slider.id.includes('Rhythm')) {
                        valueDisplay.textContent = value + (slider.id.includes('Tempo') || slider.id.includes('Volume') ? 'x' : '');
                    } else if (slider.id.includes('Filter')) {
                        valueDisplay.textContent = value + 'Hz';
                    } else {
                        valueDisplay.textContent = value;
                    }
                }
            });
        }

        // Set up slider event listeners
        function setupSliders() {
            const sliders = document.querySelectorAll('input[type="range"]');
            sliders.forEach(slider => {
                slider.addEventListener('input', () => {
                    updateSliderDisplays();
                    if (musicPlaying) {
                        updateMusicSettings();
                        setStressLevel(currentStressLevel); // Re-apply current stress level
                    }
                });
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupSliders();
            updateSliderDisplays();
            updatePresetSelect();
            console.log('Music Test: Initialized with enhanced features');
        });
    </script>
</body>

</html>