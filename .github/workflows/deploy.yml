name: Deploy to GitHub Pages

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
    types: [opened, synchronize, reopened, labeled]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: "Skip tests and deploy directly"
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Test job for all branches/PRs
  test:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.check-release.outputs.skip }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if release workflow will run
        id: check-release
        run: |
          # Check if this is a PR with documentation label
          if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ contains(github.event.pull_request.labels.*.name, 'documentation') }}" = "true" ]; then
            echo "Documentation label detected - skipping tests"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if this is a merge commit from a PR with a release label
          # OR if this is a release commit created by the release workflow
          # If so, skip tests since release workflow will run them
          if [ "${{ github.event_name }}" = "push" ]; then
            # Get the commit message
            COMMIT_MSG=$(git log -1 --pretty=%B)
            echo "Commit message: $COMMIT_MSG"
            
            # Check if this is a release commit (created by release-it)
            if echo "$COMMIT_MSG" | grep -qE "^chore: release v[0-9]+\.[0-9]+\.[0-9]+"; then
              echo "Release commit detected - skipping duplicate deploy"
              echo "skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            # Check if this is a merge commit from a PR (regular or squash merge)
            # Regular merge: "Merge pull request #123 from..."
            # Squash merge: "feat: description (#123)"
            PR_NUM=""
            if echo "$COMMIT_MSG" | grep -qE "^Merge pull request #[0-9]+"; then
              # Regular merge commit
              PR_NUM=$(echo "$COMMIT_MSG" | grep -oE "#[0-9]+" | head -1 | grep -oE "[0-9]+")
              echo "Detected regular PR merge: #$PR_NUM"
            elif echo "$COMMIT_MSG" | grep -qE "\(#[0-9]+\)\s*$"; then
              # Squash merge commit
              PR_NUM=$(echo "$COMMIT_MSG" | grep -oE "\(#[0-9]+\)" | grep -oE "[0-9]+")
              echo "Detected squash PR merge: #$PR_NUM"
            fi
            
            if [ -n "$PR_NUM" ]; then
              # Check if PR has a release or documentation label
              LABELS=$(gh pr view $PR_NUM --json labels --jq '.labels[].name' || echo "")
              echo "PR labels: $LABELS"
              
              if echo "$LABELS" | grep -qE "^release:(patch|minor|major)$"; then
                echo "Release label detected - release workflow will handle testing and deployment"
                echo "skip=true" >> $GITHUB_OUTPUT
                exit 0
              fi
              
              if echo "$LABELS" | grep -qE "^documentation$"; then
                echo "Documentation label detected - skipping tests and deployment"
                echo "skip=true" >> $GITHUB_OUTPUT
                exit 0
              fi
          fi
          echo "skip=false" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Skip if release workflow will run
        if: steps.check-release.outputs.skip == 'true'
        run: |
          echo "⏭️ Skipping tests - release workflow will handle testing and deployment"
          exit 0

      - name: Skip if manual skip requested
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.skip_tests == 'true'
        run: |
          echo "⏭️ Skipping tests - manual skip requested"
          exit 0

      - name: Setup Node.js
        if: steps.check-release.outputs.skip != 'true' && !(github.event_name == 'workflow_dispatch' && github.event.inputs.skip_tests == 'true')
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        if: steps.check-release.outputs.skip != 'true' && !(github.event_name == 'workflow_dispatch' && github.event.inputs.skip_tests == 'true')
        run: npm ci

      - name: Get Playwright version
        if: steps.check-release.outputs.skip != 'true' && !(github.event_name == 'workflow_dispatch' && github.event.inputs.skip_tests == 'true')
        id: playwright-version
        run: echo "version=$(npm list @playwright/test --depth=0 --json | jq -r '.dependencies["@playwright/test"].version')" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        if: steps.check-release.outputs.skip != 'true' && !(github.event_name == 'workflow_dispatch' && github.event.inputs.skip_tests == 'true')
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright Browsers
        if: steps.check-release.outputs.skip != 'true' && !(github.event_name == 'workflow_dispatch' && github.event.inputs.skip_tests == 'true') && steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium

      - name: Install Playwright system dependencies
        if: steps.check-release.outputs.skip != 'true' && !(github.event_name == 'workflow_dispatch' && github.event.inputs.skip_tests == 'true') && steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      - name: Validate HTML
        if: steps.check-release.outputs.skip != 'true' && !(github.event_name == 'workflow_dispatch' && github.event.inputs.skip_tests == 'true')
        run: |
          echo "Running basic validation checks..."
          # Check if index.html exists
          if [ ! -f "index.html" ]; then
            echo "Error: index.html not found"
            exit 1
          fi
          echo "✓ index.html found"

          # Check if required JS modules exist
          required_files=("assets/js/main.js" "assets/js/game-state.js" "assets/js/ui-manager.js")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "Error: Required file $file not found"
              exit 1
            fi
            echo "✓ $file found"
          done

          echo "All validation checks passed!"

      - name: Run Node.js test files
        if: steps.check-release.outputs.skip != 'true' && !(github.event_name == 'workflow_dispatch' && github.event.inputs.skip_tests == 'true')
        run: |
          echo "Running Node.js test files in tests/..."
          for testfile in tests/*.test.js; do
            echo "Running $testfile..."
            node "$testfile"
          done
          echo "All Node.js tests completed."

      - name: Run Playwright tests
        if: steps.check-release.outputs.skip != 'true' && !(github.event_name == 'workflow_dispatch' && github.event.inputs.skip_tests == 'true')
        run: npm test

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always() && steps.check-release.outputs.skip != 'true' && !(github.event_name == 'workflow_dispatch' && github.event.inputs.skip_tests == 'true')
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  # Deploy job only for main/master branch pushes or workflow_dispatch
  deploy:
    # Only run deploy job on main/master branch pushes/dispatches (not PRs)
    # Skip if release workflow will handle it, unless manual skip_tests is enabled
    if: |
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && 
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') &&
      (needs.test.outputs.skip != 'true' || (github.event_name == 'workflow_dispatch' && github.event.inputs.skip_tests == 'true'))
    needs: test
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "."

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
