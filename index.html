<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoberLife III - Stress Management Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        /* Mobile-first responsive design */
        @media (max-width: 767px) {
            body {
                align-items: flex-start;
                padding: 2px;
                min-height: 100vh;
                /* Fallback for browsers without dvh support */
                min-height: 100dvh;
            }
        }

        .game-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 20px;
            max-width: 800px;
            width: 90%;
            text-align: center;
        }

        /* Mobile viewport optimization */
        @media (max-width: 767px) {
            .game-container {
                border-radius: 10px;
                padding: 8px;
                width: 98%;
                max-height: 100vh;
                /* Fallback for browsers without dvh support */
                max-height: 100dvh;
                overflow-y: auto;
                box-sizing: border-box;
                margin: 0;
                /* Ensure container uses available space efficiently */
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
            }
            
            /* Optimize spacing for mobile */
            .game-container h1 {
                font-size: 16px;
                margin: 1px 0;
            }
        }

        .avatar-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        @media (max-width: 767px) {
            .avatar-container {
                margin-bottom: 2px;
                flex-wrap: wrap;
                gap: 3px;
            }
        }

        .avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin-right: 20px;
            transition: all 0.3s ease;
        }

        @media (max-width: 767px) {
            .avatar {
                width: 35px;
                height: 35px;
                font-size: 18px;
                margin-right: 4px;
                border: 1px solid #333;
            }
        }

        .stress-meter {
            width: 200px;
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #333;
        }

        @media (max-width: 767px) {
            .stress-meter {
                width: 100px;
                height: 14px;
            }
        }

        .stress-fill {
            height: 100%;
            transition: all 0.5s ease;
            border-radius: 8px;
        }

        .zen-points {
            font-size: 24px;
            font-weight: bold;
            color: #2E8B57;
            margin: 10px 0;
        }

        @media (max-width: 767px) {
            .zen-points {
                font-size: 12px;
                margin: 1px 0;
            }
        }

        .task-info {
            background: #F0F8FF;
            border: 2px solid #4169E1;
            border-radius: 15px;
            padding: 15px;
            margin: 20px 0;
        }

        @media (max-width: 767px) {
            .task-info {
                padding: 10px;
                margin: 15px 0;
                border-radius: 12px;
            }
            
            .task-info h3 {
                font-size: 16px;
                margin-bottom: 8px;
            }
            
            .task-info p {
                font-size: 14px;
                margin: 5px 0;
            }
        }

        .game-area {
            background: #228B22;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            color: white;
        }

        @media (max-width: 767px) {
            .game-area {
                padding: 15px;
                margin: 15px 0;
                border-radius: 12px;
            }
        }

        .cards-container {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }

        @media (max-width: 767px) {
            .cards-container {
                margin: 15px 0;
                flex-direction: column;
                gap: 15px;
            }
        }

        .player-area,
        .house-area {
            flex: 1;
            margin: 0 10px;
        }

        @media (max-width: 767px) {
            .player-area,
            .house-area {
                margin: 0;
            }
            
            .player-area h3,
            .house-area h3 {
                font-size: 16px;
                margin-bottom: 8px;
            }
        }

        .cards {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        @media (max-width: 767px) {
            .cards {
                gap: 5px;
                margin: 8px 0;
            }
        }

        .card {
            width: 60px;
            height: 80px;
            background: white;
            border: 2px solid #333;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
        }

        @media (max-width: 767px) {
            .card {
                width: 45px;
                height: 60px;
                font-size: 14px;
                border-radius: 6px;
            }
        }

        .card.red {
            color: #DC143C;
        }

        .score {
            font-size: 20px;
            font-weight: bold;
            margin: 10px 0;
        }

        @media (max-width: 767px) {
            .score {
                font-size: 16px;
                margin: 8px 0;
            }
        }

        .buttons {
            margin: 20px 0;
        }

        @media (max-width: 767px) {
            .buttons {
                margin: 15px 0;
            }
        }

        button {
            background: #4169E1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }

        @media (max-width: 767px) {
            button {
                padding: 12px 20px;
                font-size: 14px;
                margin: 4px;
                min-height: 44px;
                border-radius: 20px;
            }
        }

        button:hover {
            background: #1E90FF;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .hidden {
            display: none !important;
        }

        .survey {
            background: #FFF8DC;
            border: 2px solid #DAA520;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        @media (max-width: 767px) {
            .survey {
                padding: 4px;
                margin: 1px 0;
                border-radius: 6px;
            }
            
            .survey > p {
                font-size: 14px;
                margin: 2px 0;
                line-height: 1.3;
            }
        }

        .survey h3 {
            color: #B8860B;
            margin-bottom: 15px;
        }

        @media (max-width: 767px) {
            .survey h3 {
                font-size: 18px;
                margin-bottom: 2px;
            }
        }

        .survey-question {
            margin: 8px 0;
            text-align: left;
        }

        @media (max-width: 767px) {
            .survey-question {
                margin: 2px 0;
            }
            
            .survey-question strong {
                font-size: 16px;
                display: block;
                margin-bottom: 1px;
                font-weight: bold;
            }
        }

        .survey-question label {
            display: block;
            margin: 2px 0;
            cursor: pointer;
        }

        @media (max-width: 767px) {
            .survey-question label {
                margin: 0;
                padding: 2px 0;
                font-size: 15px;
                /* Increase touch target area */
                min-height: 30px;
                display: flex;
                align-items: center;
                line-height: 1.2;
            }
        }

        .survey-question input[type="radio"] {
            margin-right: 8px;
        }

        @media (max-width: 767px) {
            .survey-question input[type="radio"] {
                margin-right: 8px;
                /* Increase radio button size for better touch interaction */
                transform: scale(1.1);
                margin-left: 2px;
                flex-shrink: 0;
            }
        }

        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .game-over-content {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 4px solid #FF4757;
        }

        @media (max-width: 767px) {
            .game-over-content {
                padding: 20px;
                border-radius: 15px;
                width: 95%;
                max-width: 350px;
                max-height: 90vh;
                overflow-y: auto;
                border: 3px solid #FF4757;
            }
        }

        .game-over-avatar {
            font-size: 80px;
            margin-bottom: 20px;
            animation: shake 0.5s infinite;
        }

        @media (max-width: 767px) {
            .game-over-avatar {
                font-size: 60px;
                margin-bottom: 15px;
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px) rotate(-5deg);
            }

            75% {
                transform: translateX(5px) rotate(5deg);
            }
        }

        .game-over h2 {
            color: white;
            font-size: 32px;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        @media (max-width: 767px) {
            .game-over h2 {
                font-size: 24px;
                margin-bottom: 12px;
            }
        }

        .game-over-message {
            color: white;
            font-size: 18px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        @media (max-width: 767px) {
            .game-over-message {
                font-size: 16px;
                margin-bottom: 8px;
            }
        }

        .game-over-subtext {
            color: #FFE5E5;
            font-size: 14px;
            margin-bottom: 20px;
            font-style: italic;
        }

        @media (max-width: 767px) {
            .game-over-subtext {
                font-size: 12px;
                margin-bottom: 15px;
            }
        }

        .game-over-stats {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        @media (max-width: 767px) {
            .game-over-stats {
                padding: 12px;
                margin: 15px 0;
                border-radius: 8px;
            }
        }

        .game-over-stats p {
            color: white;
            margin: 5px 0;
            font-weight: bold;
        }

        @media (max-width: 767px) {
            .game-over-stats p {
                font-size: 14px;
                margin: 4px 0;
            }
        }

        #tryAgainBtn {
            background: #2ECC71;
            font-size: 18px;
            padding: 15px 30px;
            margin-top: 20px;
        }

        @media (max-width: 767px) {
            #tryAgainBtn {
                font-size: 16px;
                padding: 12px 24px;
                margin-top: 15px;
                min-height: 44px;
            }
        }

        #tryAgainBtn:hover {
            background: #27AE60;
        }

        .zen-activities {
            background: linear-gradient(135deg, #E8F5E8 0%, #D4F1D4 100%);
            border: 2px solid #2ECC71;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        @media (max-width: 767px) {
            .zen-activities {
                padding: 15px;
                margin: 15px 0;
                border-radius: 12px;
            }
        }

        .zen-activities h3 {
            color: #27AE60;
            margin-bottom: 10px;
        }

        @media (max-width: 767px) {
            .zen-activities h3 {
                font-size: 16px;
                margin-bottom: 8px;
            }
        }

        .zen-activities p {
            color: #2C3E50;
            margin-bottom: 15px;
            font-size: 14px;
        }

        @media (max-width: 767px) {
            .zen-activities p {
                font-size: 12px;
                margin-bottom: 10px;
            }
        }

        .activity-buttons {
            display: flex;
            justify-content: space-around;
            gap: 10px;
            flex-wrap: wrap;
        }

        @media (max-width: 767px) {
            .activity-buttons {
                gap: 8px;
                justify-content: center;
            }
        }

        .activity-btn {
            background: linear-gradient(135deg, #2ECC71 0%, #27AE60 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 15px 10px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
            max-width: 150px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 767px) {
            .activity-btn {
                padding: 12px 8px;
                font-size: 12px;
                min-width: 100px;
                max-width: 110px;
                min-height: 44px;
                border-radius: 10px;
            }
        }

        .activity-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .activity-btn:disabled {
            background: #BDC3C7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .activity-btn small {
            display: block;
            font-size: 11px;
            margin-top: 5px;
            opacity: 0.9;
        }

        @media (max-width: 767px) {
            .activity-btn small {
                font-size: 10px;
                margin-top: 3px;
            }
        }

        /* Viewport unit fallbacks for older browsers */
        @supports not (height: 100dvh) {
            @media (max-width: 767px) {
                body {
                    min-height: 100vh;
                }
                .game-container {
                    max-height: 100vh;
                }
            }
        }

        /* Additional mobile compatibility */
        @media (max-width: 767px) {
            /* Ensure touch targets meet accessibility guidelines */
            button, .activity-btn, input[type="radio"] {
                min-height: 44px;
            }
            
            /* Optimize for mobile performance */
            * {
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                user-select: none;
            }
            
            input[type="radio"], label {
                -webkit-user-select: auto;
                user-select: auto;
            }
            
            /* iOS Safari specific fixes */
            body {
                -webkit-overflow-scrolling: touch;
            }
            
            /* Prevent zoom on input focus */
            input, button, select, textarea {
                font-size: 16px;
            }
            
            /* Fix for iOS Safari viewport height issues */
            .game-container {
                min-height: -webkit-fill-available;
            }
            
            /* Android Chrome specific optimizations */
            button, .activity-btn {
                -webkit-appearance: none;
                appearance: none;
            }
            
            /* Improve text rendering on mobile */
            body {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                text-rendering: optimizeLegibility;
            }
        }

        /* Tablet-specific optimizations */
        @media (min-width: 768px) and (max-width: 1023px) {
            .game-container {
                max-width: 600px;
                padding: 15px;
            }
            
            .avatar {
                width: 80px;
                height: 80px;
                font-size: 32px;
            }
            
            .stress-meter {
                width: 180px;
            }
        }

        /* Landscape mobile optimizations */
        @media (max-width: 767px) and (orientation: landscape) {
            .game-container {
                max-height: 100vh;
                overflow-y: auto;
            }
            
            .avatar-container {
                margin-bottom: 5px;
            }
            
            .survey, .task-info, .zen-activities, .game-area {
                margin: 5px 0;
                padding: 6px;
            }
            
            .survey-question {
                margin: 4px 0;
            }
            
            .survey-question label {
                min-height: 32px;
                padding: 4px 0;
            }
        }

        /* Ultra-compact mobile survey for very small screens */
        @media (max-width: 767px) and (max-height: 600px) {
            .game-container h1 {
                font-size: 18px;
                margin: 3px 0;
            }
            
            .avatar-container {
                margin-bottom: 5px;
            }
            
            .avatar {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
            
            .survey {
                padding: 6px;
                margin: 3px 0;
            }
            
            .survey h3 {
                font-size: 14px;
                margin-bottom: 3px;
            }
            
            .survey > p {
                font-size: 11px;
                margin: 3px 0;
            }
            
            .survey-question {
                margin: 5px 0;
            }
            
            .survey-question strong {
                font-size: 12px;
                margin-bottom: 2px;
            }
            
            .survey-question label {
                min-height: 32px;
                padding: 3px 0;
                font-size: 11px;
                margin: 2px 0;
            }
        }
    </style>
</head>

<body>
    <div class="game-container">
        <h1>üßò SoberLife - IIIüßò</h1>

        <!-- Avatar and Stress Meter -->
        <div class="avatar-container">
            <div class="avatar" id="avatar">üòä</div>
            <div>
                <div>Stress Level</div>
                <div class="stress-meter">
                    <div class="stress-fill" id="stressFill"></div>
                </div>
                <div class="zen-points" id="zenPoints">Zen Points: 100</div>
            </div>
        </div>

        <!-- Survey Section -->
        <div class="survey" id="surveySection">
            <h3>Pre-Task Assessment</h3>
            <p>Before we begin your DMV visit, let's assess your current stress level:</p>

            <div class="survey-question">
                <strong>How did you sleep last night?</strong>
                <label><input type="radio" name="sleep" value="0"> Great! 8+ hours of solid sleep</label>
                <label><input type="radio" name="sleep" value="10"> Pretty well, 6-8 hours</label>
                <label><input type="radio" name="sleep" value="20"> Not great, 4-6 hours</label>
                <label><input type="radio" name="sleep" value="30"> Terrible, less than 4 hours</label>
            </div>

            <div class="survey-question">
                <strong>How prepared do you feel for the DMV?</strong>
                <label><input type="radio" name="prepared" value="0"> Very prepared, all documents ready</label>
                <label><input type="radio" name="prepared" value="10"> Mostly prepared</label>
                <label><input type="radio" name="prepared" value="20"> Somewhat prepared</label>
                <label><input type="radio" name="prepared" value="30"> Not prepared at all</label>
            </div>

            <div class="survey-question">
                <strong>How's your day been so far?</strong>
                <label><input type="radio" name="day" value="0"> Amazing, everything's going smoothly</label>
                <label><input type="radio" name="day" value="10"> Pretty good</label>
                <label><input type="radio" name="day" value="20"> Okay, some minor issues</label>
                <label><input type="radio" name="day" value="30"> Stressful, lots of problems</label>
            </div>

            <div id="surveyError" style="color: red; font-weight: bold; margin: 10px 0; display: none;">
                Please answer all questions before beginning your DMV visit!
            </div>
            <button id="startGameBtn" onclick="startGame()" disabled>Begin DMV Visit</button>
        </div>

        <!-- Task Info -->
        <div class="task-info hidden" id="taskInfo">
            <h3>üèõÔ∏è Task: DMV License Renewal & Real ID</h3>
            <p id="taskDescription">Step 1: Check in at the front desk</p>
            <p>Complete each step by getting closer to 21 than the house without going over!</p>
        </div>

        <!-- Zen Activities Panel -->
        <div class="zen-activities hidden" id="zenActivities">
            <h3>üßò Stress Relief Activities</h3>
            <p>Use your zen points to manage stress during your DMV visit:</p>
            <div class="activity-buttons">
                <button class="activity-btn" onclick="useZenActivity('breath')" id="breathBtn">
                    üå¨Ô∏è Deep Breath<br>
                    <small>10 zen points ‚Ä¢ -10% stress</small>
                </button>
                <button class="activity-btn" onclick="useZenActivity('stretch')" id="stretchBtn">
                    ü§∏ Quick Stretch<br>
                    <small>25 zen points ‚Ä¢ -20% stress</small>
                </button>
                <button class="activity-btn" onclick="useZenActivity('meditation')" id="meditationBtn">
                    üßò Mini Meditation<br>
                    <small>50 zen points ‚Ä¢ -35% stress</small>
                </button>
            </div>
        </div>

        <!-- Game Area -->
        <div class="game-area hidden" id="gameArea">
            <div class="cards-container">
                <div class="player-area">
                    <h3>You</h3>
                    <div class="cards" id="playerCards"></div>
                    <div class="score" id="playerScore">Score: 0</div>
                </div>
                <div class="house-area">
                    <h3>House</h3>
                    <div class="cards" id="houseCards"></div>
                    <div class="score" id="houseScore">Score: ?</div>
                </div>
            </div>

            <div class="buttons">
                <button id="hitBtn" onclick="hit()">Hit</button>
                <button id="standBtn" onclick="stand()">Stand</button>
                <button id="nextStepBtn" onclick="nextStep()" class="hidden">Next Step</button>
            </div>

            <div id="roundResult"></div>
        </div>

        <!-- Game Over Screen -->
        <div class="game-over hidden" id="gameOverScreen">
            <div class="game-over-content">
                <div class="game-over-avatar">ü§Ø</div>
                <h2>STRESS OVERLOAD!</h2>
                <p class="game-over-message">You've reached maximum stress levels and had a complete meltdown at the
                    DMV!</p>
                <p class="game-over-subtext">The clerk called security, your paperwork got lost, and you're now banned
                    from this location for 30 days.</p>
                <div class="game-over-stats">
                    <p>Final Stress Level: <span id="finalStressLevel">100%</span></p>
                    <p>Steps Completed: <span id="stepsCompleted">0/5</span></p>
                </div>
                <button id="tryAgainBtn" onclick="restartGame()">Try Again (And Maybe Meditate First)</button>
            </div>
        </div>
    </div>

    <script>
        // Game state
        let gameState = {
            zenPoints: 100,
            stressLevel: 0,
            currentStep: 1,
            totalSteps: 5,
            playerCards: [],
            houseCards: [],
            deck: [],
            gameInProgress: false
        };

        const steps = [
            "Check in at the front desk",
            "Wait in line for your number to be called",
            "Present your documents to the clerk",
            "Take your photo for the Real ID",
            "Pay the renewal fee and receive your temporary license"
        ];

        const suits = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'];
        const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];

        function createDeck() {
            const deck = [];
            for (let suit of suits) {
                for (let value of values) {
                    deck.push({
                        suit: suit,
                        value: value,
                        numValue: getCardValue(value)
                    });
                }
            }
            return shuffleDeck(deck);
        }

        function shuffleDeck(deck) {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        }

        function getCardValue(value) {
            if (value === 'A') return 11;
            if (['J', 'Q', 'K'].includes(value)) return 10;
            return parseInt(value);
        }

        function calculateScore(cards) {
            let score = 0;
            let aces = 0;

            for (let card of cards) {
                if (card.value === 'A') {
                    aces++;
                    score += 11;
                } else {
                    score += card.numValue;
                }
            }

            while (score > 21 && aces > 0) {
                score -= 10;
                aces--;
            }

            return score;
        }

        function startGame() {
            // Validate that all survey questions are answered
            const sleepAnswer = document.querySelector('input[name="sleep"]:checked');
            const preparedAnswer = document.querySelector('input[name="prepared"]:checked');
            const dayAnswer = document.querySelector('input[name="day"]:checked');

            if (!sleepAnswer || !preparedAnswer || !dayAnswer) {
                const errorMsg = document.getElementById('surveyError');
                errorMsg.style.display = 'block';
                return;
            }

            // Calculate initial stress from survey
            const surveyInputs = document.querySelectorAll('input[type="radio"]:checked');
            let initialStress = 0;

            surveyInputs.forEach(input => {
                initialStress += parseInt(input.value);
            });

            gameState.stressLevel = initialStress;
            gameState.zenPoints = Math.max(50, 150 - initialStress);

            updateDisplay();
            updateZenActivities();

            document.getElementById('surveySection').classList.add('hidden');
            document.getElementById('taskInfo').classList.remove('hidden');
            document.getElementById('zenActivities').classList.remove('hidden');
            document.getElementById('gameArea').classList.remove('hidden');

            startNewRound();
        }

        function startNewRound() {
            gameState.deck = createDeck();
            gameState.playerCards = [];
            gameState.houseCards = [];
            gameState.gameInProgress = true;

            // Deal initial cards
            gameState.playerCards.push(gameState.deck.pop());
            gameState.houseCards.push(gameState.deck.pop());
            gameState.playerCards.push(gameState.deck.pop());
            gameState.houseCards.push(gameState.deck.pop());

            updateDisplay();
            updateCards();

            document.getElementById('hitBtn').disabled = false;
            document.getElementById('standBtn').disabled = false;
            document.getElementById('nextStepBtn').classList.add('hidden');
            document.getElementById('roundResult').innerHTML = '';

            // Update task description
            document.getElementById('taskDescription').textContent =
                `Step ${gameState.currentStep}: ${steps[gameState.currentStep - 1]}`;
        }

        function hit() {
            if (!gameState.gameInProgress) return;

            gameState.playerCards.push(gameState.deck.pop());
            updateCards();

            const playerScore = calculateScore(gameState.playerCards);
            if (playerScore > 21) {
                // Player busted
                endRound('bust');
            }
        }

        function stand() {
            if (!gameState.gameInProgress) return;

            // House plays
            while (calculateScore(gameState.houseCards) < 17) {
                gameState.houseCards.push(gameState.deck.pop());
            }

            const playerScore = calculateScore(gameState.playerCards);
            const houseScore = calculateScore(gameState.houseCards);

            if (houseScore > 21) {
                endRound('house_bust');
            } else if (playerScore > houseScore) {
                endRound('win');
            } else if (playerScore === houseScore) {
                endRound('tie');
            } else {
                endRound('lose');
            }
        }

        function endRound(result) {
            gameState.gameInProgress = false;
            document.getElementById('hitBtn').disabled = true;
            document.getElementById('standBtn').disabled = true;

            // Update cards display now that game is over
            updateCards();

            let resultText = '';
            let zenChange = 0;
            let stressChange = 0;

            switch (result) {
                case 'win':
                case 'house_bust':
                    resultText = 'üéâ You stayed calm and handled this step well!';
                    zenChange = 15;
                    stressChange = -5;
                    break;
                case 'tie':
                    resultText = 'üòê You managed okay, but could have been smoother.';
                    zenChange = 5;
                    stressChange = 5;
                    break;
                case 'lose':
                    resultText = 'üò∞ This step was more stressful than expected.';
                    zenChange = -10;
                    stressChange = 15;
                    break;
                case 'bust':
                    resultText = 'üòµ You got overwhelmed and lost your cool!';
                    zenChange = -25;
                    stressChange = 30;
                    break;
            }

            gameState.zenPoints = Math.max(0, gameState.zenPoints + zenChange);
            gameState.stressLevel = Math.max(0, Math.min(100, gameState.stressLevel + stressChange));

            updateDisplay();

            document.getElementById('roundResult').innerHTML = `
                <p style="font-size: 18px; margin: 10px 0;">${resultText}</p>
                <p>Zen Points: ${zenChange > 0 ? '+' : ''}${zenChange} | Stress: ${stressChange > 0 ? '+' : ''}${stressChange}</p>
            `;

            if (gameState.currentStep < gameState.totalSteps) {
                document.getElementById('nextStepBtn').classList.remove('hidden');
            } else {
                // Game complete
                document.getElementById('roundResult').innerHTML +=
                    '<p style="color: white; font-weight: bold;">üéä Congratulations! You successfully completed your DMV visit!</p>';
            }
        }

        function nextStep() {
            gameState.currentStep++;
            startNewRound();
        }

        function updateCards() {
            const playerCardsEl = document.getElementById('playerCards');
            const houseCardsEl = document.getElementById('houseCards');

            playerCardsEl.innerHTML = '';
            houseCardsEl.innerHTML = '';

            // Player cards
            gameState.playerCards.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'card';
                if (card.suit === '‚ô•' || card.suit === '‚ô¶') {
                    cardEl.classList.add('red');
                }
                cardEl.textContent = card.value + card.suit;
                playerCardsEl.appendChild(cardEl);
            });

            // House cards (hide hole card only if game is still in progress)
            gameState.houseCards.forEach((card, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = 'card';

                // Hide the hole card (second card) only while game is in progress
                if (gameState.gameInProgress && index === 1) {
                    cardEl.textContent = '?';
                    cardEl.style.background = '#333';
                    cardEl.style.color = 'white';
                } else {
                    // Show all cards when game is over
                    if (card.suit === '‚ô•' || card.suit === '‚ô¶') {
                        cardEl.classList.add('red');
                    }
                    cardEl.textContent = card.value + card.suit;
                    cardEl.style.background = 'white';
                    cardEl.style.color = card.suit === '‚ô•' || card.suit === '‚ô¶' ? '#DC143C' : '#333';
                }
                houseCardsEl.appendChild(cardEl);
            });

            // Update scores
            const playerScore = calculateScore(gameState.playerCards);
            document.getElementById('playerScore').textContent = `Score: ${playerScore}`;

            // Show house score when game is over
            if (gameState.gameInProgress) {
                document.getElementById('houseScore').textContent = 'Score: ?';
            } else {
                const houseScore = calculateScore(gameState.houseCards);
                document.getElementById('houseScore').textContent = `Score: ${houseScore}`;
            }
        }

        function updateDisplay() {
            // Update zen points
            document.getElementById('zenPoints').textContent = `Zen Points: ${gameState.zenPoints}`;

            // Update stress meter
            const stressFill = document.getElementById('stressFill');
            const stressPercent = gameState.stressLevel;
            stressFill.style.width = `${stressPercent}%`;

            // Color based on stress level
            if (stressPercent < 30) {
                stressFill.style.background = '#32CD32';
            } else if (stressPercent < 60) {
                stressFill.style.background = '#FFD700';
            } else {
                stressFill.style.background = '#FF6347';
            }

            // Update avatar based on stress
            const avatar = document.getElementById('avatar');
            if (stressPercent < 20) {
                avatar.textContent = 'üòä';
                avatar.style.background = '#90EE90';
            } else if (stressPercent < 40) {
                avatar.textContent = 'üôÇ';
                avatar.style.background = '#F0E68C';
            } else if (stressPercent < 60) {
                avatar.textContent = 'üòê';
                avatar.style.background = '#DDA0DD';
            } else if (stressPercent < 80) {
                avatar.textContent = 'üò∞';
                avatar.style.background = '#F0A460';
            } else {
                avatar.textContent = 'üòµ';
                avatar.style.background = '#FA8072';
            }

            // Update zen activities availability
            updateZenActivities();

            // Check for game over condition
            if (stressPercent >= 100) {
                showGameOver();
            }
        }

        function updateZenActivities() {
            const breathBtn = document.getElementById('breathBtn');
            const stretchBtn = document.getElementById('stretchBtn');
            const meditationBtn = document.getElementById('meditationBtn');

            // Enable/disable buttons based on available zen points
            breathBtn.disabled = gameState.zenPoints < 10;
            stretchBtn.disabled = gameState.zenPoints < 25;
            meditationBtn.disabled = gameState.zenPoints < 50;
        }

        function useZenActivity(activity) {
            let cost = 0;
            let stressReduction = 0;
            let activityName = '';
            let message = '';

            switch (activity) {
                case 'breath':
                    cost = 10;
                    stressReduction = 10;
                    activityName = 'Deep Breath';
                    message = 'üå¨Ô∏è You take a deep, calming breath and feel more centered.';
                    break;
                case 'stretch':
                    cost = 25;
                    stressReduction = 20;
                    activityName = 'Quick Stretch';
                    message = 'ü§∏ You do some quick stretches and release tension from your body.';
                    break;
                case 'meditation':
                    cost = 50;
                    stressReduction = 35;
                    activityName = 'Mini Meditation';
                    message = 'üßò You close your eyes and meditate for a moment, finding inner peace.';
                    break;
            }

            // Check if player has enough zen points
            if (gameState.zenPoints < cost) {
                return;
            }

            // Apply the activity
            gameState.zenPoints -= cost;
            gameState.stressLevel = Math.max(0, gameState.stressLevel - stressReduction);

            // Show feedback
            const roundResult = document.getElementById('roundResult');
            roundResult.innerHTML = `
                <div style="background: #E8F5E8; border: 2px solid #2ECC71; border-radius: 10px; padding: 15px; margin: 10px 0; color: #27AE60;">
                    <p style="font-size: 16px; margin: 5px 0;">${message}</p>
                    <p><strong>-${cost} zen points | -${stressReduction}% stress</strong></p>
                </div>
            `;

            updateDisplay();
        }

        function showGameOver() {
            // Update game over stats
            document.getElementById('finalStressLevel').textContent = `${gameState.stressLevel}%`;
            document.getElementById('stepsCompleted').textContent = `${gameState.currentStep - 1}/${gameState.totalSteps}`;

            // Show game over screen
            document.getElementById('gameOverScreen').classList.remove('hidden');
        }

        function restartGame() {
            // Reset game state
            gameState = {
                zenPoints: 100,
                stressLevel: 0,
                currentStep: 1,
                totalSteps: 5,
                playerCards: [],
                houseCards: [],
                deck: [],
                gameInProgress: false
            };

            // Hide game over screen
            document.getElementById('gameOverScreen').classList.add('hidden');

            // Show survey section again
            document.getElementById('surveySection').classList.remove('hidden');
            document.getElementById('taskInfo').classList.add('hidden');
            document.getElementById('zenActivities').classList.add('hidden');
            document.getElementById('gameArea').classList.add('hidden');

            // Clear survey selections
            const radioButtons = document.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(radio => {
                radio.checked = false;
            });

            // Reset button state
            document.getElementById('startGameBtn').disabled = true;
            document.getElementById('surveyError').style.display = 'none';

            // Update display
            updateDisplay();
        }

        // Initialize display
        updateDisplay();

        // Add event listeners to survey radio buttons
        function checkSurveyCompletion() {
            const sleepAnswer = document.querySelector('input[name="sleep"]:checked');
            const preparedAnswer = document.querySelector('input[name="prepared"]:checked');
            const dayAnswer = document.querySelector('input[name="day"]:checked');

            const startBtn = document.getElementById('startGameBtn');
            const errorMsg = document.getElementById('surveyError');

            if (sleepAnswer && preparedAnswer && dayAnswer) {
                startBtn.disabled = false;
                errorMsg.style.display = 'none';
            } else {
                startBtn.disabled = true;
                errorMsg.style.display = 'none'; // Hide error until they try to click
            }
        }

        // Add listeners to all radio buttons
        document.addEventListener('DOMContentLoaded', function () {
            const radioButtons = document.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', checkSurveyCompletion);
            });

            // Initial check
            checkSurveyCompletion();
        });

        // If DOM is already loaded, run immediately
        if (document.readyState === 'loading') {
            // Do nothing, event listener above will handle it
        } else {
            const radioButtons = document.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', checkSurveyCompletion);
            });
            checkSurveyCompletion();
        }
    </script>
</body>

</html>